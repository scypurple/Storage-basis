# **第6章 备份技术**







## 谈重复数据删除技术的风险和预防之策

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-22*

大家都知道，把所有鸡蛋都放到同一个篮子不是一个好主意。

 

其实，许多中小企业的备份管理员很容易犯一个错误，这也是重复数据删除所带来的风险。

 

这个错误就是：使用重复数据删除技术却不对数据进行复制（比如克隆）。

 

无论你用的是哪种重复数据删除系统，都得使用Raid不是吗？如EMC的重复数据删除产品Avamar和Data Domain，部署的时候都离不开Raid。

 

大家都知道，Raid虽然可以保护数据因为磁盘损坏而丢失，但是它无法防止人为的误操作，比如不小心误删了数据。

 

所以，与传统备份方式相比较，重复数据删除技术就好比把所有的鸡蛋放到了一个篮子里。为了更好的理解重复数据删除技术带来的风险，我们通过举例来说明：

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEkuU2ytC92A387uz6jTYJmHp9AHwkvTd7du1dTEQs0tBKtfV9mUL8icxiaw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

如上图所示，假如我们每周做一次1.1TB的完全备份，其他几天都作增量备份且平均增量备份的数据量是0.1TB。这样每周我们备份的总量是1.1TB+0.1TB*6=1.7TB。3个星期后我们的备份总量是1.7TB*3=5.1TB。

 

下面我们来看一看同样情况下使用重复数据删除技术的情形：

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEkugF6tSeQIsBsRebWZwcRHjU9We0koZmibTibHJNZJcMgLiahP3jO4Tbb9Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

如上图我们可见，使用重复数据删除技术以后，第一周备份的数据量是1.7TB，第二和第三周备份的数据量分别是0.6TB（增量备份的那部分），所以到第2周为止备份总量是2.3TB，到第3周为止备份总量是2.9TB。

 

可以看到，使用重复数据删除技术以后，备份的数据量大大减少了。为什么会这样呢？因为重复数据删除技术消除了冗余，不存储额外的数据副本，相同的数据只存储一份。

 

由此可见，重复数据删除技术就好比把所有的鸡蛋放入一个篮子里。如果你不小心删除了备份数据，或者整个Raid出现了问题，那么你不仅仅是丢失这一部分的备份，而是会丢失所有涉及该数据的所有备份，这可能会导致你一无所有，造成无法承受的损失。这点你绝对需要引起重视。

 

**那么有何预防之策呢？**

 

当然有。其实方法也很简单，这就是：使用重复数据删除技术的时候，对数据做复制（比如做克隆）。这样数据才能得到保护，也就等同于在另一个篮子中放一模一样的一篮鸡蛋了。

 

虽然克隆对于不使用重复数据删除技术的环境也很重要，但是即使你在不使用重复数据删除技术的环境中没有做克隆，你仍旧有机会来弥补数据丢失的损失。这是因为你有数据的多个副本，比方说假如你想恢复第2周的数据但是失败了，但是至少你还有第1周和第3周的完全备份，可以用来恢复第1周或第3周的数据。虽然会损失一部分数据，但至少大多数数据都还完好无缺。

 

说到这里，大家应该都已经明白，我们在使用重复数据删除技术的时候，一定要记得对数据做复制。Deduplication = Replication。如果你还没有这样做的话，那么你做的是不正确的。赶紧复制一份鸡蛋放到另一个篮子里吧。











## NAS环境中的备份

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-20*

备份是容灾的基础，是指为防止系统出现操作失误或系统故障导致数据丢失，而将全部或部分数据集合从应用主机的硬盘或阵列复制到其它的存储介质的过程。公司还可以利用备份来遵循法规要求。执行备份的目的有三个：灾难恢复、操作恢复和归档。数据备份做为数据高可用的最后一道防线，其重要性不言而喻。本文将介绍NAS环境中的几种常见备份方式。

 

NAS 是一种采用直接与网络介质相连的特殊设备实现数据存储的机制。由于这些设备都分配有IP 地址，所以客户机通过充当数据网关的服务器可以对其进行存取访问，甚至在某些情况下，不需要任何中间介质客户机也可以直接访问这些设备。该技术能够满足那些希望降低存储成本但又无法承受SAN昂贵价格的中小企业的需求，具有相当好的性能价格比。

 

NAS机头是做为NAS环境中的备份和恢复应用的核心组件。NAS机头使用支持多种文件共享协议的专用操作系统和文件系统结构。在NAS环境中，可以通过不同方式实施备份：基于服务器的备份、无需服务器的备份或使用网络数据管理协议（NDMP）的备份。通常实施的备份是NDMP2路备份和NDMP3路备份。

 

 

**基于服务器的备份**

 

在基于应用程序服务器的备份中，NAS机头会通过网络检索存储整列中的数据，并将其传输到应用程序服务器上运行的备份客户端。备份客户端会将该数据发送到存储节点，存储节点继而将该数据写入备份设备。这会导致网络备份数据超载，以及使用应用程序服务器资源来移动备份数据。

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEkunjp4O5tRzyBN8MibbOnztyysx3mryRib5ZeACLsTXB1DRiaMUiboHm5Bvw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 



**无需服务器的备份**

 

在无需服务器的备份中，网络共享直接装载在存储节点上。在此情况下，存储节点（也是备份客户端）会从NAS机头读取数据，并将其写入备份设备，而不会涉及应用程序服务器。如此可避免网络超载，也不需要使用应用程序服务器上的资源。

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEkupZk7EvkV4clBMx01npVlUzJQIOMxEunRzEoWakaa56rDUCyK500yAg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 



**使用网络数据管理协议（NDMP）的备份**

 

NDMP 是基于TCP/IP的行业标准协议，专为NAS环境中的备份而设计。数据可以通过NDMP备份，不受操作系统或平台限制。由于这种灵活性，它不再需要通过应用程序服务器传输数据，从而减少了应用程序服务器上的负载，并提高了备份速度。在NDMP中，备份数据直接从NAS机头发送到备份设备，而元数据将发送到备份服务器。在NDMP2路方法中，数据移动发生在NAS和本地连接的备份设备之间。在网络上只传输元数据。由于备份设备专用于NAS设备，因此这种方法不支持对该环境中所有备份设备进行集中管理。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEku8ETfBffR7Cccckhh0BdHnlmzr5YspoFFYXHBFA4RBllNQiaicDicB8v6Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 



需要在NAS机头间共享备份设备时，可以使用NDMP3路备份。采用此方式时，NAS机头可控制备份设备并与其他NAS机头共享该设备。在NDMP3路方法中，必须在所有NAS机头之间建立单独的专用备份网络并将NAS机头连接到备份设备。原数据和NDMP控制数据仍然通过公用网络进行传输。



![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXClPplbwicH0ksJVHqzzEkuibtMzHoZuw2tdL42SWvPmw65mLy8Bhgcjf1CHggbre2OvFibNV2kIvwQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)











## 制定备份策略需要考虑哪些因素？

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-23*

   数据丢失的多少以及RTO和RPO衡量的业务能容忍的停机时间是选择实现特定备份策略的主要考虑因素。另一考虑因素就是留存周期，即定义了业务需要备份复制的持续时间。某些数据需保存数年而一些则仅需保留几天。例如，用于归档的备份数据留存的时间要比用于操作性恢复的数据留存时间长。



   根据留存时间和数据可获取性，备份介质的类型也是非常重要的考虑因素。组织结构必须也考虑备份的粒度。备份策略的制定必须确定一个进行备份的最佳的时间，以求把任何对生产性操作的干扰降到最低。类似地，恢复操作的位置和时间也必须根据文件的特征和影响备份的数据压缩等进行考虑。



   文件的位置、大小及其数目因其影响备份过程，也应纳入考量。对于将要备份的数据其位置是非常重要的考虑因素。许多组织结构具有非常多的异构平台以支持复杂方案，例如从许多源中使用备份数据的数据仓库环境就是这样的。备份过程必须以相互作用和内容完整性方式说明这些源，且该过程必须在保存数据的所有异构型平台协作下完成。



   文件大小也影响备份过程。备份大文件（如10个1MB文件）也许使用比备份同等数据量但是由多个小文件组成的数据更少的资源（如10000个1KB文件）。当文件系统包括多个小文件时，备份和恢复将占用更多时间。



   类似于文件大小，备份文件数目也影响备份过程。例如，在增量式备份，具有1000000文件而且日常变化率为10%的文件系统将不得不在备份目录中创建100000个入口。备份目录包括了备份数据集的内容表和关于备份会话的信息。文件系统中如此大量的入口将因搜索文件系统时间过长而影响备份和恢复过程的性能。



   备份性能也依赖于备份所用的介质。在基于磁带系统中时间较长的启动停止操作将会影响备份性能，特别是在备份大量小文件的时候。



   因为压缩节省介质空间，所以在备份系统中广泛使用压缩技术。许多备份设备（例如磁带驱动器）具有内建基于硬件的数据压缩支持。为了有效利用压缩，了解数据的特点是非常重要的。某些数据（如应用代码）不能很好压缩，而文本数据适于压缩，特别像其他的数据（如JPEG和ZIP文件）已经被压缩了。











## 备份系统的设计和备份技术的选择

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-24*

   本文中笔者小结一些自己对于备份系统的设计和备份技术的选择方面的心得，并结合EMC的产品，从多角度做一些简要的分析。

 

 

**重复数据删除技术的选择:**

 

   备份的时候进行重复数据的删除的好处是显而易见的，也已成为目前业界的主流技术。这类技术目前的发展方向，最常见的方式，以除重操作发生的位置来划分：

1. 在数据源端(基于主机)备份，备份之前就做除重了，然后再备份。这种方式能避免更多重复数据为了消重而通过网络传输到备份服务器，减轻了网络压力，但是缺点是会占用备份客户机的时间和资源来做消重。
2. 在备份服务器端来做除重，在线处理（Inline或联机处理），Data Domain就是这一技术的代表，这一方式中，数据在读进来之后，在存到磁盘之前就已经进行了重复数据删除，也就是一边备份，一边除重。In-line的优势是节省了磁盘空间，同时重复数据删除一步到位，特别简单，但缺点是对CPU的损耗非常大，会占用大量CPU资源，导致性能下降。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArOvxh6xoHsJic6vb7ObtzBfxfkGWHyiaAg7s02EddvJcm7ebbGBZkqj7g/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

 

   所以我们在选择使用哪种重复数据删除技术的时候应该先弄清楚，自己的重复数据在哪里发生的最多，再决定是不是在那个位置来进行重复数据删除。假如是在一个企业内部，发件人给所有员工发了一封带附件的邮件，这些数据都是存储在主机上，这种情况下可以采用基于主机的重复数据删除。



   Avamar软件和Data Domain重复数据删除存储系统是目前EMC重复数据删除解决方案的核心。在EMC的重复数据删除技术蓝图中，Avamar和Data Domain被赋予不同的工作目标，Avamar更侧重于源端，更偏向在VMware虚拟化环境、备份服务器、在线复制等应用领域，其最新的进展是EMC将Avamar推进到了桌面和移动办公领域；Data Domain的工作则更多的侧重在目标端，即业务系统后端所连接的存储、备份和归档、容灾设备。

 

 

**可扩展性的选择:**

 

 ![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBAr1ZYNkPSkZBiaOgYTKknUDibKFEsV0WIjX4W2lib9oMXuCYKr0QPiaeLJag/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

 

   企业级的备份系统的架构应当是及其灵活的和可延展的，这样才是对分布式企业环境来说的理想的解决方案。公司的备份策略要从一个中心区域到遍及所有机构，都能够得到技术实现、贯彻执行和集中管理。备份系统要支持本地区域网络和广泛区域网络的连接。



   在系统实施以后，数据在不同的物理站点之间的传递流转产生的网络压力要尽可能地减少。无论本地还是远程的主机上的数据都集中备份到中心区域的服务器上。作为一个集中化的备份系统，它不需要在分支机构的站点部署任何的硬件或者驻留任何的备份管理员就能对这些分支机构的数据提供保护。



   对一个拥有众多分支机构的大型企业来说，我们在一个集中化的备份系统里就能够备份所有分支机构的数据并自动复制备份数据到中心站点和专门的灾备站点。此外，我们还能把存储在中心备份服务器上的管理数据和用户数据都复制到一个远程的灾备站点。所有的备份、恢复和复制的活动都在中央数据中心使用亲和的图形化界面的工具统一管理。

 

 

**灾备技术的选择：**

 

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArBibPdNKJWot5s8chU8l4cR0TeQ7mQCgABSM8Yvbib5AzgHv2Qia4zYKjg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



   最常见的灾备技术就是异地复制，就是把本地备份系统上的数据通过广域网复制到远程的备份系统上。为了减少网络流量和节约时间，我们应当只把经过重复数据消除技术处理过的备份数据复制到灾备系统上。

 

   理解与复制技术有关的所有硬件和软件，对于设计一套备份和恢复系统是非常重要的。作为设计者，需要考虑到的方方面面包括：

1. 一套受支持的存储阵列，例如：EMC Symmetrix 或者CLARiiON，或者其他具备合适级别的固件和API的存储阵列
2. 一套受支持的快照软件解决方案，例如：MS VSS，EMC TimeFinder或者SnapView
3. 一套受支持的操作系统并安装了备份软件的服务器版，客户机版和任何需要的备份代理程序，例如：EMC Networker，Samentac NetBackup
4. 一系列经过授权的备份软件的应用模块，适用于普通电脑终端的备份、数据库的备份、大数据量文件系统的备份，例如：Networker server/client，Networker SnapImage， Networker Module for Oracle
5. 一套受支持的物理卷（介质）管理工具，例如：EMC Unisphere
6. 一套受支持的备份源端到目标端的数据传递的多路径解决方案，例如：EMC PowerPath
7. 一个设计合理的整体基础架构，例如：基于共享存储的SAN，基于主机自用磁盘的LAN

 

 

   许多用户都会在设计和实施复制方案的时候面对这样一个简单的问题：要不要使用备份软件来管理基于磁盘存储的复制？

实现备份和复制不仅仅要考虑清楚硬件和软件，还要分清业务需求和要求。考量一个复制方案是否经得起推敲，可以从以下方面入手：

1. 对于商务应用和业务数据来说，怎样的恢复时间目标（RTO）和恢复时间点目标（RPO）是可以接受的？
2. 备份数据和复制数据要分别安排在怎样的时间窗口内才是合理的？
3. 谁来执行数据恢复？恢复工具易于操作吗？恢复流程明确周详吗？
4. 目前备份系统用到了哪些硬件技术和软件技术？
5. 可用于改善备份系统的财务预算和实施周期是怎样定义的？

 

 

   那么，那种备份解决方案最好呢？这个问题的答案必须基于用户对上述问题的考虑以及最终确定的各个细节。业务系统的类型和使用环境的可用性极大程度地触发了一个又一个实施方案的选择。



   镜像和克隆典型地被用在含有重要数据的环境中，尤其是在短时间内会发生大量数据改变的情况，但是他们的使用成本和维护成本会高于仅使用快照技术的备份系统。





   在Microsoft Windows的环境中，推荐使用VSS快照技术完成备份作业。



   对于含有大数据量的文件系统，推荐使用Server less和NDMP技术。



   实现基于任意时间点的恢复能最大限度地达到RTO和RPO，EMC Recoverpoint能提供这方面的解决方案。

 

 

**虚拟机备份技术的选择：**  

 

   不同的数据中心环境适用不同的方案。主流的实现方式包括：

Guest-based：基于客户机的方式。这种方式的配置和备份物理机的配置如出一辙，没有任何额外的步骤。在此不表。

vStorage APIs：基于代理服务器的方式。这是目前最高效的方式。

 

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBAr1dhvvQkRpK3kAQ27L0JfCpAzkCaiaib08dicMtibG8SG478kbYZJXhVsicA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

   这样的数据保护就能支持LAN-free的备份，并且把所有备份相关的资源开销都集中到一个代理服务器上。备份的时候，系统会创建一个虚拟机的vmdk文件的快照，这个vStorage APIs的代理服务器能够挂载这个快照，并通过备份软件直接备份这个快照，这样的备份就是镜像级别的了。当然为了让备份服务器能识别和管理这个代理服务器，我们需要在他上面安装备份软件的代理程序，由这个代理程序提供备份服务，所有的备份操作都在这个代理服务器上完成。一个代理服务器能为多个ESX主机上的虚拟机提供备份服务。



   考虑到效率，我们建议把这些虚拟机都部署在共享存储环境中，例如：SAN，便于代理服务器读写。笔者的经验是，如果把这个代理服务器也存放在同一套共享存储中，备份的效率会更高。

 

 

**设计一个完整的备份架构：**

 

   就以下图作为模拟，整理下构建备份系统的思路。

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArtYYIVt6Cq7xaibicGIEnMTAbGrWaeS458IbUvlJdppWGicFXcUpagh6jw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

   首先，横向来看，既要有在线备份，也要有离线备份。数据从左至右依次经过客户端、备份服务器、一级存储介质、二级存储介质。在备份系统中，我们要规划好各层之间的网络连接，部署成本和管理平台。如果需要异地长期保存数据的，还要考虑如何转移磁带，如何存放和管理便于恢复的时候支取。对于多级存储介质，磁盘阵列和磁带库，最好能通过统一存储工具进行管理，而且容量、性能和高可用性是最主要的三个方面，需要在成本允许的范围内取得平衡。事先和应用部门就这些方面做一次modeling来明确这些方面的细节。



   然后，纵向来看，既要有磁带备份，也要有磁盘备份。至于两者之间的比较，就不再本文赘述了。感兴趣的读者，请自行查找其他资料。值得一提的是，在现在介质成本不断下降的大环境下，磁盘的优势非常明显，建议有条件优先考虑，选择知名厂商的成熟存储阵列产品。



   最后，我们推荐结合EMC的三大备份产品搭建这个环境。



   利用Avamar和Networker内嵌的DD Boost向Data Domain目标备份Exchange、Oracle、SharePoint、SQL Server和VMware镜像。Avamar自有的Data Store有效容量翻番达到124TB。与之相比，Data Domain目标系统可用容量为285TB。Networker更是能通过添加外部设备直接使用更多更大容量的一级磁盘阵列和二级磁带库。用户能够将DD Boost所支持应用的备份发送至Data Domain目标，而其他应用备份将发送至Avamar Data Store，以此最大化备份整体性能，并加速Avamar和Networker客户端。



   Networker备份客户端在备份时，可以选择要除重还是不要除重。如果不要除重，把它备份到Networker后面管理的其他备份设备上，可以是一级磁盘阵列也可以是二级磁带库，甚至Data Domain都是可以的。另一个是带除重的选项，这时选中后，备份设备备份到Avamar或者Data Domain的磁盘里，这个结合的好处：用同一个客户端选择要除重还是不要除重，并且整个备份策略是由Networker统一管理的，也就是说这个数据用了除重或非除重的备份方式，备份的数据存在什么样的备份设备上，还有备份策略、备份周期，是什么样的都是由Networker来管理的，所以有一些客户已经把Avamar，Networker和Data Domain结合起来一起使用了。

 

 

**备份系统“软”技术的选择：**

 

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArD7Ztlt7vdWyicj8kk0KsQnRp3jwulc0sSQoNgs5kSYq6BWrkvnPRTog/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



   写到最后，笔者想把对备份系统设计中最容易被轻视的“软”技术的探讨作为本位的结尾。所谓的“软”技术，包括这些内容：

1. 根据业务的需求，我们要制定怎样的备份策略才能在充分利用上述所有系统配置和环境资源来实现日常的备份任务？
2. 哪些技术和非技术人员会参与备份系统的日常维护和管理，他们的身份验证和系统权限作出了怎样的定义？
3. 当需要进行数据恢复的时候，流程足够清晰吗？恢复数据直接可用吗？

















## LTO线性磁带开放技术简介

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-26*

当前磁带市场的主要磁带格式有LTO、DDS/DAT、DLT 和AIT等。其中，LTO是主流磁带格式。根据Santa Clara咨询公司的调查显示，2012年第4季度LTO磁带的销售量仍在小幅上涨，LTO磁带销售占有率高达93%。本文将主要介绍LTO磁带格式。

 

LTO即Linear Tape Open，中文叫做线性磁带开放。这种磁带数据存储技术由惠普、IBM和希捷三家厂商在1997年共同开发，在90年代后期成为一种开放格式磁带存储标准。经过十几年的开发，从2000年LTO-1的面世到去年年底最新LTO-6的正式推出，LTO技术不断得到进步和发展。



   ![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWhv3VVa1anVxFqFsGaiao99IS3icIjr6vEVH7AMoYAoRl8icN5IUDZ98aE1ibyjNLZ8vKIsW5TFl3bUg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)                ![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWhv3VVa1anVxFqFsGaiao999HjqsxHuDpAwgKOly8UicpZlsnFNmJTldHXF6Z2Fe9LJZyQWaWBt6icw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

“开放格式”指的是用户可以访问多种互相兼容的存储介质产品来源。LTO标准格式技术叫做Ultrium，最早每个LTO-1磁带盒可存储100GB数据，现在每个LTO-6磁带盒可容纳2.5TB数据。

 

十多年来，LTO的技术进步涉及到好几个因素，包括磁带的生产材料、使用的数字编码和压缩方式、磁带在驱动器中的物理移动速度、每个磁带盒中的磁带长度以及磁带中数据的物理密度等等。

 

来看看LTO磁带的演变史：

 

**LTO-1:**

- 2000年9月面世销售。
- 初始容量为100GB。
- 初始数据传输速度为20MB/s（最大）。
- 磁带编码为RLL 1,7。

 

**LTO-2:**

- 2003年2月获批，2003年3月首批产品上市。
- 容量翻倍至200GB。
- 提高数据传输速度至40MB/s（最大）。
- 磁带编码改为PRML。

 

**LTO-3:**

- 004年11月获批。
- 容量翻倍至400GB。
- 提高数据传输速度至80MB/s（最大）。
- 推出WORM功能。

 

**LTO-4:**

- 2007年4月获批，2007年5月首批产品上市。
- 容量再次翻倍至800GB。
- 提高数据传输速度至120MB/s（最大）。
- 推出驱动器级256-bit AES-GCM加密功能。

 

**LTO-5：**

- 2010年1月19日发布规格说明。2010年第二季度首批LTO-5驱动器上市。
- 容量将近翻倍至1.5TB (1500GB)。
- 提高数据传输速度至140MB/s（最大）。
- 推出分区功能，允许磁带被“分拆”成两个独立的写区域。LTFS（线性磁带文件系统）需要此功能的支持。

 

**LTO-6:**

- 2012年6月11日发布规格说明。
- 容量增加至2.5TB。
- 由于更大压缩缓存的使用，提高了数据压缩率。
- 提高数据传输速度至160MB/s（最大）。

 

**LTO-7：**

- 容量计划可增加至6.4TB。
- 计划提高数据传输速度至315MB/s（最大）。

 

**LTO-8 （正在研发中）：**

- 容量计划可增加至12.8TB。
- 计划提高数据传输速度至472MB/s（最大）。

 

虽然磁带解决方案近年来正在迅速被备份到磁盘解决方案所取代，但是磁带的经济性和便携性使它仍然成为异地存储的理想选择。即使是当前越来越火热的云平台，磁带作为一种长期保存数据的解决方案，仍然有其继续存在的重要价值.













## 浅谈重复数据删除的实现

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-25*

重复数据删除指的是备份时找到并消除重复的数据，以提高备份的效率。本文将介绍重复数据删除的级别和种类，让大家了解重复数据删除是如何实现的，以及重复数据删除能够给我们带来些什么好处。

 

先来看一个考小朋友的问题：“以下一共有几种水果？“

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKRWzK9moysa7ZvBuFyMFvWyiatrHJQOiaBAZCQD8QDoj6BsBO5a8QVJQw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

小朋友最后从一大堆水果中挑出不一样的12种来。这就是最简单的重复数据删除。重复数据删除看似简单，其实在实际生产环境中的实现还挺复杂的。不同重复数据删除的产品最终所能达到的数据消重率和完成的时间效率大相径庭。今天就让我们来看一看实际生产环境中是如何实现重复数据删除的。

 

**
**

**重复数据删除的级别：**

 

重复数据删除通过识别重复或冗余数据来降低存储需求。重复数据删除有多种级别，每个级别所对应的文件冗余识别能力有所不同：

 

**文件级别重复数据删除**：只要文件有任何修改，整个文件就被认为是一个新的文件，因而会被存储。只有在文件没有任何修改的情况下，该文件才被认为是个冗余文件，从而无需再次存储，但是会创建一个指针从冗余文件指向备份文件，并且保留指针和元数据。需要恢复文件的时候，可以通过唯一文件以及相应的指针或元数据来实现。这种重复数据删除级别效率较低。EMC Avamar包含文件级别重复数据删除功能。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKz8fYpia4eoX8EqfLNcKPZU8ExKocrGqMRNWXMNCuiakktFMwOm7t3jbg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**固定长度数据块重复数据删除**：常用于快照与复制技术，文件被分割成固定长度的数据块，能够更高效的识别数据的冗余性。但是，因为数据块是固定长度的，所以即使修改文件的一小部分，也有可能导致所有数据块都被修改。例如，如图所示，假如需要添加一个数据块到已有的数据块中，整个数据流都要往后挪以便腾出地方。这种重复数据删除级别效率也不是很高。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKggeW5FbKnYbzUeicft15ibfb6xUySL9dajeTVkdTnCnlRHia4wt5YkcCw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**可变长度数据段重复数据删除**：在固定长度数据块重复数据删除基础上加以改进，使用一种智能化的方法来确定数据块的大小，着眼于数据本身来确定数据块的分界点。可变长度数据块重复数据删除提供更佳的粒度识别重复数据，消除了文件级别和固定长度数据块重复数据删除的低效率。使用可变长度数据块重复数据删除，当添加数据时，数据可被加入可变长度数据块中，整个数据流无需挪动。因此，更多数据块会被定义为相同数据块，要存储的数据也随之减少。在固定长度数据块重复数据删除和可变长度数据块重复数据删除中，同样也会保留指向唯一数据段的指针和元数据。EMC Avamar和Data Domain使用的都是可变长度数据块重复数据删除。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKa7yaqJdx7Y89awnXLeZ5ZpYpKos59wMPOI1PbL7WlIzRsecbV1YGDg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





**重复数据删除的种类：**

 

按照重复数据删除操作所执行的对象，重复数据删除可分为两种：

 

**源端重复数据删除**：在客户端既数据的源头作重复数据的识别，并将重复数据删除以后的数据通过网络传输并存储到磁盘上进行备份。EMC Avamar提供的就是这种重复数据删除方式。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKjcY342sgxE8RJ1K6Fk9poUKM1jlFurv6xZhjjvVjUcrBc7uQKibuhkQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**目标端重复数据删除**：将数据从客户端发送到目标存储设备上，然后在目标存储设备上进行重复数据删除。此时，不同厂商所提供的目标端重复数据删除产品的差距就体现出来了。很多其他厂商的目标端重复数据删除产品需要将数据先存到磁盘上的一个临时区域，然后再进行重复数据删除，而且无法对重复数据删除之后的数据进行压缩。这样不但需要有额外的磁盘，而且需要额外的人力去管理处于不同状态的数据池中的数据。EMC Data Domain使用的则是一种称为“内联”的重复数据删除方式，在将数据存储到目标存储设备之前，就对数据进行重复数据删除。99%的数据段冗余分析是在内存中完成的，只有一小部分未能在内存中识别的数据会和磁盘中已存储的数据去比较。由于重复数据删除基本是在内存中完成的，很少访问磁盘，所以重复数据删除的速度很快。如果数据块被识别为是旧的，该数据不会被再存储但是会给它创建一个指针。随后，Data Domain会将经过重复数据删除处理以后的数据进行压缩，然后存储到目标存储设备的磁盘上。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKYiapekqz9v9YRySWUZlDeafZqFqauC4WCf7uqKhgicWCiaatkAFunbbjQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKB1Jr9f71GpkLich9Yw0vJmibBxUxlQ9YhKzibOUM3sp5IqgSkbsmFbSFQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIXqbGcFcjFFqyyp9c7f7BLKFPicChJz2bLBicWicet1XAnibdjBDictGIV4h9G06GibrERn4Rr08VqUiaVnw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



使用重复数据删除功能的好处主要有：

- 减少磁盘空间：重复数据删除之后，数据量可以减少几十倍，很大程度上降低了磁盘空间的负担。
- 提高备份速度：重复数据删除极大的减少了所需备份的数据量，缩短了备份窗口。
- 降低网络负载：对于源端重复数据删除而言，由于所要传输的数据量大为减少，网络带宽压力得到减轻。
- 加快数据恢复：由于重复数据删除以后的数据量少了很多，数据长期存于磁盘可成为现实。由于数据是在磁盘而不是磁带中，所以读取数据的数据会大大加快。
- 改进数据保护：不使用重复数据删除的情况下，很多时候因为备份时间段的限制我们也许只能进行每周完整备份和每日增量备份。使用重复数据删除以后，我们很可能将能够采取更积极的备份策略， 如每日完全备份。

















## 物理磁带库简介

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-29*

物理磁带库是一种存储设备，包含一个或多个磁带机、许多插槽、一个条形码阅读器以及一个用于装载磁带的自动机械臂。

 

备份软件能够智能管理机械臂和整个备份过程。磁带驱动器可以从磁带上读取数据，也可以将数据写入磁带。机械臂用于在物理磁带库中移动磁带，例如移动磁带到插槽或磁带机。有一种特殊的插槽叫邮槽或导入/导出插槽，用于往物理磁带库中添加磁带或从磁带库中取出磁带，而无需打开物理磁带库的检修门。因为打开检修门会造成物理磁带库离线，所以邮槽其实提供了一种保持物理磁带库在线的情况下，添加或取出磁带的方式。此外，物理磁带库中的每个物理组件都各自有一个地址，用于在物理磁带库中移动磁带时的寻址。当备份过程开始时，机械臂会根据指示装载一盘磁带到一个磁带机中。这个过程根据所用硬件的不同会增加了一定程度的延迟，一般大概需要5到10秒来挂载磁带。磁带被挂载以后，还需要花一些时间用于磁头定位和报头信息验证。总的时间可能从几秒钟到几分钟不等。磁带机收到备份数据后会将数据存入它的内部缓存。然后，备份数据会按块写入磁带。在这个过程中，磁带机最好能够保持繁忙状态以防块之间有间隔，这可以通过缓存数据到磁带机上来实现。我们还可以调节磁带机的速度来匹配数据传输率。

 

物理磁带库通常还有光学扫描磁带上所贴的条形码标签的能力，这使它能够自动清点物理磁带库中的磁带，确认哪些磁带在哪些位置。预印的条形码标签可从商业渠道获得，自定义的标签可使用商业或免费软件生成。条形码标签常常是磁带标签的一部分，信息记录于介质的开始部分，用于唯一识别磁带。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWOjvNGPMZAHP9ibnbGrHsd09BFJYpgqEbzQkzCZMoCgVMINQLIoHlBiaIHe9sZ3ffo2gKUxuPeTx3Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)   ![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWOjvNGPMZAHP9ibnbGrHsd0ZFOPJzlOCNaibyk3PKZibqyfsj00Uxz9TOvVm4kMn3ic3KbnRl0LqicVzw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



物理磁带库主要用于大容量数据存储和读取，是一种节约成本的解决方案。缺点是读取速度较慢，因为常常涉及到磁带的机械操纵。读取数据可能需要花费几秒钟到几分钟。由于它的慢速顺序访问和大容量特性，物理磁带库主要用于备份或最终用于数据归档。

 

目前市面上常见的物理磁带库品牌有IBM、HP、SUN、STK、QUANTUM、ADIC、DELL、OVERLAND、SPECTRA LOGIC等。

















## 备份和归档的区别

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-01*

如今已经进入大数据的时代，每天都有无数的数据在全世界范围内产生。有些企业每年所产生的数据都在成倍增长。如何有效并可靠的保存快速增长的数据已成为很多企业的巨大挑战。备份和归档是现今企业中最流行的两种数据保护方式。本文将介绍下这两种数据保护方式各自的含义和相互间的区别。

 

**备份：**

 

备份可以创建数据的副本（文件、数据库等），用于防止因为人为错误、系统崩溃和自然灾害造成的数据丢失。当原始数据丢失时，可以通过获取数据副本来获得想要的数据。备份适合快速恢复大量数据的场景。但是，由于数据的快速增长，备份环境可能需要不断拓展，这对于备份管理员而言是一件头疼的事情。磁带和磁盘提供高可靠性，通常被用作备份的介质。但是，如果一个备份系统没有使用合适的数据管理软件，它就会显得非常低效甚至无效。如果企业决定长期保留数据，那么对备份系统的投资花销、时间成本以及专业人员数量都会有较高的要求。总而言之，备份主要是复制那些经常需要读取或更新的在线数据。

 

**归档：**

 

文件归档是现今另一种数据保护的流行形势。由于归档使用相对较便宜的存储介质（如磁带），并且可以离线存储，所以归档可达到减少开支和方便存放介质的目的。文件归档系统还可以根据文件属性来保存文件。这些属性可以是作者、修改日期或者一些其他的自定义标签。归档系统会保存文件本身以及它们的元数据和属性。此外，归档系统还会提供压缩功能。总而言之，归档主要是将不再需要经常读取或更新的备份数据长期离线保存，并按属性打上归档标签，方便将来的搜索。

 

**备份和归档的区别：**

 

备份和归档系统的目的是不同的。它们应当一起被用来实现数据的保护。备份主要用于保存数据的副本，达到数据保护的目的；归档作为数据管理的一种方式长期组织并保存数据。换句话说，备份可以认为是短期保存副本，而归档则被认为是长期保留文件的方式。在现实生活中，你通常不会在备份之后删除原始副本。但是，一旦文件被归档了，原始文件就可以被删除了，因为我们很可能不再需要去快速获取它了。备份和归档相辅相成，配合一起使用可以更好的保护数据。

 

EMC Data Domain系统是一款理想的备份和归档数据的保护存储平台。各种各样的数据，如数据库、虚拟机、应用程序、邮件服务器、共享文件、内容管理等，都可以通过Data Domain进行备份和归档，从而得到有效的保护。Data Domain现在可支持16种以上不同的归档软件，包括EMC归档产品DiskXtender、SourceOne、Could Tiering Appliance和Documentum以及第三方厂商归档产品Symantec Enterprise Vault、AXS-One、DataGlobal、Arkivio等。













## 备份架构——三种基本备份拓扑

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-31*

最常见的基本备份拓扑有三种：直连备份、基于LAN的备份和基于SAN的备份。我们来简单介绍下它们各自的概念和优缺点。

 

在直连备份模式中，备份数据直接从主机备份到磁带中，不经过LAN。备份任务由备份客户端发起，直接将数据备份到与客户端相连的磁带设备中。在这种模式中，我们无法进行集中管理，也很难拓展现有的环境。这种备份拓扑的主要优点是速度快，磁带设备可以最大化的发挥自己的I/O速度。由于磁带设备与数据源紧密相连并且提供给主机专用，所以备份和恢复数据的速度能够得到优化。直连备份的缺点是由于备份需要消耗主机I/O的带宽、内存和CPU资源，所以它们会影响到主机以其应用程序的性能。此外，直连备份还有距离上的限制，尤其是当使用如SCSI这类短距离连接的时候。

 

在下图中，客户端同时也是存储节点，承担将数据写入备份设备的责任。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7YB28AtQ5LJdrjsU8NOUwANbgwIooUDI528zfsp6H0z6lqNnzLPcxCavxSokxqZr6oUQRc0QianA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



在基于LAN的备份模式中，备份数据从主机通过LAN备份到磁带中。备份服务器作为控制中心控制所有的备份任务。在这种模式中，我们可以进行集中管理但是LAN的高负载率可能会是一个问题，因为所有数据都会经过LAN。这种备份拓扑的主要优点是能够集中化管理备份和磁带资源，从而提高操作的效率。缺点是备份流程可能会对生产系统、客户端网络和应用程序造成影响，因为它会消耗CPU、I/O带宽、LAN带宽和内存。

 

下图列出了最简单的传统基于LAN的备份拓扑。所有系统都由LAN相连并且所有存储设备都是直连的（磁带本地直连在备份服务器上）。数据备份应当找到一条从源端（备份客户端）到目标端（备份设备）的最佳路径，从而最小化对网络可能造成的影响。减少影响的方式可能有多种，比如：给不同的备份任务专门配置不同的网络以及在应用服务器上配置专用存储节点等。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7YB28AtQ5LJdrjsU8NOUwDb8ke6xnCKz3UtWjvvmENkxR81bXsx3Ue7kjdolXjXdTCx0zhrb6Qw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



在基于SAN的备份模式（LAN-Free）中，备份数据通过SAN来传输，LAN只用于传输元数据。备份元数据包含被备份的文件的信息，如文件名、备份时间、文件大小和权限、文件所有人以及用于快速定位和恢复数据的跟踪信息等。基于SAN的备份优化了备份的整个过程，包括提供光纤性能、高可靠性、长距离、无需LAN来传输备份数据、无需专用备份服务器以及高性能备份恢复等特性。这种模式可以提供更好的备份性能和更简化的管理，但是需要额外的设施建设投资开销。

 

如下图所示，磁带库和客户端都被连接到SAN，所有客户端都可以共享一个单独的磁带库。客户端从SAN中读取数据并将数据写入与SAN相连的磁带中。数据总在SAN环境中传输，唯一通过LAN传输的只有元数据。



![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7YB28AtQ5LJdrjsU8NOUwibyaWzT3IMa7orgmAmngicZkMVfuZk0zYODPJ0DWAlURFicicBArPI2UOQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)















## 虚拟磁带库(VTL)简介

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-05-30*

虚拟磁带库(VTL)是一种常用于备份和恢复目的的数据存储虚拟化技术。

 

目前，大多数虚拟磁带库使用SAS或SATA磁盘阵列作为主要的存储组件。阵列盘柜的使用可以提高解决方案的可拓展性。通过增加更多的磁盘驱动器和盘柜，可以增加存储容量。

 

对于备份软件而言，物理磁带库和虚拟磁带库没有什么不同。虚拟磁带库提供虚拟磁带库模拟功能将VTL中的物理磁盘呈现为磁带备份设备。由于虚拟磁带库看起来就好像是物理磁带库，此功能使得企业能够轻松集成虚拟磁带库到现有的备份环境中，而无需对备份软件作任何更改。

 

相较于物理磁带库，虚拟磁带库能够提供更好的单数据流性能、更高的可靠性和随机磁盘访问等特点。由于磁盘总是在线并保持随时可用，所以备份和恢复的效率得到了很大的提升。虚拟磁带不需要像对待物理磁带机那样进行常规维护操作，如定期清洗和驱动器校准。此外，使用虚拟磁带库并不需要在备份软件上安装额外的模块或做出特别的改变。

 

虚拟磁带库和物理磁带库具有相同的组件，除了虚拟磁带库中的大部分组件是以虚拟资源呈现的。虚拟磁带库使用磁盘作为备份媒介来模拟磁带的行为。模拟引擎是一个具有定制化操作系统的专门服务器，将虚拟磁带库中的物理磁盘呈现为磁带备份设备。模拟软件中包含一个含有虚拟磁带库列表的数据库，每个虚拟磁带被分配磁盘上的一部分LUN。如果需要的话，虚拟磁带可以跨多个LUN。虽然使用的是备份到磁盘技术，但是文件系统的识别不是必须的，因为虚拟磁带库可以使用裸设备。不像物理磁带库会有机械延迟，虚拟磁带库的访问几乎是瞬间完成的。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWMglVdBZJrWia1IPgH1icsO84H4cZicfjQGcormWvU4qibC3Qddgic91Jv1I3KRDZZxI1CicWCzRbdCarw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



传统的虚拟磁带库面临一些挑战比如：磁盘相对较贵，长期存放数据成本较高，最后可能仍需要将数据存放到物理磁带上；数据量较大不利于跨广域网复制到远程站点实现灾难恢复等。EMC Data Domain既能够提供虚拟磁带库功能，又由于自身强大的重复数据删除机制，使得这些难题都迎刃而解。















## 面向大数据的归档解决方案

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-08*

   EMC Isilon大数据归档解决方案瞄准了日益增长的信息和数据保留需求。特别适合大型企业、媒体和娱乐公司以及需要处理大数据的公司。高扩展性、易于管理的特性使得它可以轻松减少您的投资，简化存储管理并遵循企业及各种合规要求。



   本文将介绍Isilon横向扩展存储在大数据归档方面的优势。关于Isilon产品的介绍可以参考论坛之前的文章：

   [EMC Isilon– “Scale Out”时代](http://mp.weixin.qq.com/s?__biz=MjM5NjY0NzAwMg==&mid=2651770987&idx=3&sn=549561e905a9d86c4bcef20443ce4fef&scene=21#wechat_redirect)

   [Isilon系列产品的应用场景](http://mp.weixin.qq.com/s?__biz=MjM5NjY0NzAwMg==&mid=2651770988&idx=3&sn=8e06db705dc9d947b5878671839f9072&scene=21#wechat_redirect)

 



**同时为在线和归档数据服务:**

 

   通过Isilon 系列节点的集群使用，单个Isilon NAS群集可以同时被多种工作负载使用，包括目录、虚拟化文件存储和归档库，而不用担心对性能的影响以及对长期数据保存的特殊处理。除此之外它还有以下关键优势：



- 提供在线存储级性能的归档服务：对大数据归档，Isilon瞬时访问速度可以扩展到超过每秒100 GB的吞吐量。
- 自动管理和自我修复功能：单个Isilon群集可以方便地扩展至超过20 PB的容量。系统的自我管理和分配功能可以监控系统并自我修复系统内的任何故障。
- 消除数据迁移风险：当新的存储节点、更新或更有性价比（存储效率）的硬盘被加入到系统中时，可以提供自动迁移功能。它不会有磁带介质退化的问题，使得长期归档服务成为了可能。

 



**高可用和数据保护：**

 

   Isilon OneFS操作环境通过FlexProtect技术提供横向扩展的数据保护。区别于传统的RAID技术，FlexProtect采用特定于文件的方法来实现数据保护，为每个文件单独存储保护信息。这种独立保护允许将保护数据连同文件数据一起散布在整个群集中，从而在需要时大幅提高数据访问和重建的潜在并行度。



在Isilon存储系统中存在节点或驱动器故障时，FlexProtect能够确定文件的哪些部分受故障的影响，并让多个节点仅参与受影响的文件的重新构建。



   Isilon SmartLock技术添加了一个安全层，保护归档数据不会因为意外、提前或恶意的变更而被删除。SmartLock企业版（Enterprise Edition）符合最严格的SEC-17a4法规，它能和Isilon OneFS操作系统完整结合并无缝地与其它的OneFS应用整合，比如SmartPools自动存储分层、SnapshotIQ和SyncIQ本地和远程数据复制和灾难恢复技术。关于Isilon数据保护方面的内容可以参看之前的文章：

   [详解Isilon数据保护和备份技术](http://mp.weixin.qq.com/s?__biz=MjM5NjY0NzAwMg==&mid=2651770998&idx=3&sn=ff1109149479510189900f5de4e2f6e1&scene=21#wechat_redirect)

 



**减少大数据归档的存储成本：**

 

   Isilon横向扩展NAS为非结构化数据提供了最有效的空间使用效率，提供显著的资本和运营支出结余。它提供开放的、标准的NAS和基于RESTful对象接口协议。为您企业内部应用选择合适的归档方案提供了便利。一旦数据从主存储归档，Isilon会使用一系列功能确保归档文件尽可能有效率地存放：



- 单文件系统和单存储卷的简化使得其存储利率用超过80%。和传统的归档系统不同，Isilon群集的存储效率、可用性和性能会在容量提升时同步提升。
- SmartPools技术提供自动化的、基于策略的分层策略。根据相关性和权值，数据会被放入高性能的存储池或高容量的存储池中。
- 简单的、横向扩展的架构可以整合文件数据，减少整个组织内文件的存放位置。从而减少管理成本和归档的操作流程。

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWYic4OUw50MP0iaaD65RraK7UgkQCa1MAh74g5KhPicVqNMjJCxtUjRAfYY6bgaRF01AGtyGpZo5ZHg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)















## 备份基础之备份策略

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-07*

   备份策略是事先准备和将要实施的一组保护用户重要数字资产免于硬盘故障、病毒攻击和其他灾难事件引起的损失的流程。本文将介绍备份策略的一些基本知识。

 

**备份策略的要求:**

 

当设计备份策略时，下面几项要求是需要注意的：

- 能够在所有的数据丢失情形下恢复数据，如硬盘故障、病毒攻击、失窃、意外删除、数据错误、火灾、洪水、地震或其他灾难等
- 能够在必要时恢复到更早的时间点
- 能够以最少的操作、成本和数据丢失且尽可能快地恢复
- 在初始设置后仅需要最少的人员交互和维护成本。能够自动或半自动化

 



**规划备份策略：**

 

1. **备份目标**

   备份策略的第一步是确认要备份哪些东西。识别哪些文件、目录和数据是你不能丢失的。它包括所有文档、数据库、图片、视频、音乐和应用程序等。

   

2. **备份至何处**

   一个不错的备份策略一般会同时包含有本地备份和异地备份。本地备份由于其较低的成本，可以让你轻松备份大量的数据。本地备份通常还能提供非常快的恢复速度。而异地备份可以让你在一些大型灾难出现时不至于“全军覆没”。

   

3. **何时备份**

   主要考虑下面几点：

   **频率**：多久备份一次。在决定频率时需考虑最坏情形下（比如正要开始下一次备份，灾难出现了），你可以承受丢失的最大数据量。

   **备份开始时间**：通常在对主机和应用影响最少的时候开始备份。在业务时间后执行规划备份任务是一个很好的应用实践。备份通常不会在主机关机或休眠时执行，因此需要备份的数据都需要正常开启（服务器一般都是24小时运行，因此通常都是在夜晚执行备份任务）。一些备份软件错过备份任务时，会在下一次主机一开机时就执行备份任务。

   

4. **备份类型**

   一些常见的备份类型包括完全备份、增量备份和差异备份。这些备份类型的功能和区别参考论坛之前的文章：[备份基础之完全、增量与差异备份](http://mp.weixin.qq.com/s?__biz=MjM5NjY0NzAwMg==&mid=2651770991&idx=1&sn=e6618e33b9a18e01411eaf8e691819b9&scene=21#wechat_redirect)

   

   

   

5. **压缩（消重）和加密**

   如果数据较大，或者重复数据较多，可以考虑启用压缩或重复数据删除（消重）技术。如果备份的是非常敏感的数据，也可以对备份数据启用加密。

   

6. **测试备份**

   备份仅在可以被成功恢复时才有意义。因此周期性地测试你的备份是很有必要的。一些备份工具提供验证备份的功能。当然，每隔一段时间执行一次完整且真实的备份是非常好的习惯。













## 数据库备份注意事项

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-13*

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWwfgvLMK9ZvmiaLdF2EXQC05ibcKaFpNxmA1EGpW949RqPTdrjInXrnnYE42EX7mGRkMWh6aov5r8A/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



   作为一个数据库管理员，应该选择怎样的备份策略呢？建议您问自己两个问题。



1. 您管理的数据库最多能够容忍多长时间的数据丢失？
2. 您准备投入多少人力物力来做数据库备份与恢复策略？



   问题似乎有点残酷。但是世界上大多数事情，要获得越好的效果，就需要越多的投入。数据库备份策略尤其是这样。



​    本文将介绍数据库备份需要注意的一些基本事项。

 

**数据丢失因素:**

 

   不考虑镜像技术（比如SQL Server自己的数据库镜像和物理磁盘级镜像），数据库不可能时时刻刻地做数据库备份，每次备份之间总要有一定的时间间隔。而这个间隔之间的数据变化在下一次备份之前，是没有保护的。所以讲到底，数据丢失的最大时间段，就是两次备份之间的时间间隔。利用备份恢复机制保护数据，是不可能保证数据一点都不丢失的。如果您的用户提出的要求是不能有任何数据丢失，则必须跟用户沟通，让他们了解这样的要求仅使用数据库备份技术实现是不现实的，需要做更大的投入，引入镜像技术。



   既然数据丢失的最大时间段，就是两次备份之间的时间间隔，那么备份做得越多，数据丢失量就会越少。可是，做备份越频繁，需要的投入也越多。涉及的因素有：



1. 备份越多，要管理的备份文件也越多，数据库恢复时要恢复的文件也越多。要建立一个合适的备份管理制度。
2. 备份虽然不会阻塞数据库的正常操作，但是会产生一系列的硬盘读写。如果服务器本身I/O就比较繁忙，备份动作会进一步影响数据库的性能。须要增强服务器的硬盘读写处理能力，才能避免这种问题发生。
3. 备份难免会因为种种因素失败。备份越勤，遇到失败的几率越大。管理员要及时处理错误，将备份任务恢复常态。这对管理员的要求也比较高。



   当您对将要投入的人力物力心中有数以后，就可以来决定采用什么样的备份策略了。使用日志备份，可以将数据库恢复到故障点或特定的时点。所以日志备份在备份策略中扮演着很重要的角色。但是日志备份只能在完整恢复模式和有些大容量日志恢复模式的数据库上进行。制定备份策略，首先要决定是否需要做日志备份。如果需要做日志备份，数据库恢复模式就要选成完整模式。（大容量恢复模式不能总保证日志备份成功，所以一般不推荐在生产环境下使用）如果不做日志备份，数据库模式就要设置简单，否则会遇到日志文件无限增长问题。

 

**简单恢复模式下的备份：**

 

   简单恢复模式下，不能做日志备份。所以它只支持最简单的备份和还原方式，很容易管理。不过如果没有日志备份，就只能将数据库恢复到最后一次备份的结尾。如果发生灾难，数据库最后一次备份之后做的数据修改将全部丢失。在简单恢复模式下，工作损失风险会随时间增长而增加，直到进行下一个完整备份或差异备份为止。因此，建议您排订充足的备份的频率，以避免遗失大量数据。同时，频率也不能太高而让备份变得难以管理。



   为了降低风险，可以引入差异备份。使用差异数据库备份补充数据库完整备份，是减轻工作损失风险的一种备份策略。在第一次数据库备份之后，连续建立了3次差异备份。第3个差异备份后，进行数据库完整备份，建立新的差异基准。因为差异备份的开销一般都比完整备份低，所以能够比较经常地运行。这样的备份策略可以使用在数据量稍大，能够容忍较长时间数据丢失的数据库上。



   以上两种备份策略的优势，是不管是备份还是恢复，管理起来都比较简单。但是不管是数据库完整备份，还是差异备份，都不可能以比较频繁的频率进行，一般都只能在晚间进行。如果数据库比较庞大，或者不允许比较长时间的数据丢失，这样的备份策略是不能满足要求的。必须引入日志备份，建立更为复杂，但是也更强大的备份恢复策略。

 

**完整恢复模式下的备份：**

 

   选取完整恢复模式，就可以使用日志备份。由于日志备份只拷贝上次日志备份以来的所有日志记录，所以开销会比数据库备份小很多。可以定义以一种很频繁的频率（5分钟甚至更短）来做备份，以达到在最大限度内，防止出现故障时丢失数据的目的。使用日志备份的优点是允许您将数据库还原到日志备份内包含的任何时点（“时点恢复”）。假定可以在发生严重故障后备份活动日志，则可将数据库一直还原到没有发生数据丢失的故障点处。使用日志备份的缺点是它们的数量很多，而且恢复备份时，需要严格按照备份产生的顺序依次恢复。中间不能有任何备份缺失或跳跃。所以日志备份做得越多，还原时间就越长，管理复杂性也越高。



   在第一个完整数据库备份完成，并且常规日志备份开始之后，潜在的工作丢失风险存在时间，仅为数据库损坏时点，到上一次常规日志备份的那一段时间。因此，建议经常执行日志备份，以将工作丢失的风险限定在业务要求所允许的范围内。出现故障后，可以尝试备份“日志尾部”（尚未备份的日志）。如果尾日志备份成功，则可以通过将数据库还原到故障点来避免任何工作丢失。所以这种备份计划的优点也是很明显的。



   但是上述备份计划的一大缺陷，就是灾难发生后需要恢复的日志文件数目太多。假设每个小时做一次日志备份，每周日做一次数据库备份，如果灾难在周五发生，就不得不恢复上百个日志备份。这个工作量和所要花的时间是很大的。为了最大程度地缩短还原时间，可以对数据库进行一系列差异备份做补充。

 

**文件或文件组备份：**

 

   完整文件备份指备份一个或多个文件或文件组中的所有数据。在完整恢复模式下，一整套完整文件备份和跨所有文件备份的日志备份合起来，等同于一个完整数据库备份。使用文件备份能够只还原损坏的文件，而不用还原数据库的其余部分，从而可加快恢复速度。例如，如果数据库由位于不同磁盘上的若干个文件组成，在其中一个磁盘发生故障时，只须还原故障磁盘上的文件。



   文件备份在默认情况下包含足够的日志记录，可以将文件前滚至备份操作的末尾。（但是在简单恢复模式下，必须一起备份所有读/写文件，而不是逐个指定每个读/写文件或文件组）相对于数据库备份，文件备份具有如下优点：



- 能够更快地从隔离的媒体故障中恢复。可以迅速还原损坏的文件。
- 与完整数据库备份（对于超大型数据库而言，变得难以管理）相比，文件备份增加了计划和媒体处理的灵活性。文件或文件组备份的更高灵活性对于包含具有不同更新特征的数据的大型数据库也很有用。



   与完整数据库备份相比，文件备份的主要缺点是管理较复杂。如果某个损坏的文件未备份，那么媒体故障可能会导致无法恢复整个数据库。因此，必须维护一组完整的文件备份，对于完整/大容量日志恢复模式，还必须维护一个或多个日志备份，这些日志备份至少涵盖第一个完整文件备份和最后一个完整备份之间的时间间隔。维护和跟踪这些完整备份是一种耗时的任务，所需空间可能会超过完整数据库备份的所需空间。所以这种备份策略在实际使用中应用得还是比较少的。它只有在管理超大数据库时，才能发挥出其不可替代的优势。



   在完整恢复模式下，一整套完整文件备份与涵盖从第一个文件备份开始的所有文件备份的足够日志备份合起来等同于完整数据库备份。仅使用文件备份和日志备份还原数据库的操作可能比较复杂。因此，如果可能，最好执行完整数据库备份并在第一个文件备份开始之前开始日志备份。创建了第一个数据库备份之后，便可开始执行事务日志备份。事务日志备份计划按设置的间隔执行。文件备份以最适合数据库业务要求的间隔执行。



   在完整恢复模式下，恢复一个文件组备份，不但需要恢复文件组备份本身，还需要依次恢复从上一次完整数据库备份后，到恢复的目标时间点为止的所有日志备份，以确保该文件与数据库的其余部分保持一致。所以要恢复的事务日志备份数量会很多。要避免这种情况，可以考虑使用差异文件备份。可是这样会使整个备份计划更加难于管理。这也是为什么文件备份不常使用的重要原因。但是在管理超大数据库时，这可能是唯一的选择。

















## 浅谈虚拟磁带库备份的性能问题

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-08*

​    很多时候，用户会反映DD VTL备份速度比较慢，甚至比物理带库还要慢很多。因此他们就会怀疑DD不过尔尔没有传说中的牛叉。基本上对于这样的怀疑，我都会淡然一笑然后帮助他们找到问题的根源。其实80%以上的性能问题都和Data Domain本身没有关系，而是由于前期实施阶段没有规划好而导致的后遗症或者是主机，网络压力过大产生的性能瓶颈。



​    接下来，我会简单地和大家分享一下我的个人心得体会，希望会对大家有所帮助。众所周知，性能调优向来都是一个极其复杂而且繁琐的系统工程，因为它涉及到各种操作系统平台，不同的通信协议。在这里，一是由于本人的知识有限，二是真的往细了说估计三天三夜也说不完，因此我只会谈一些和VTL相关的点，不做很深入的展开。



   既然都说了性能问题这么复杂，那么我们不妨先来看看到底有哪些因素可以影响到数据备份和恢复的性能呢？



1. 备份服务器的硬件配置，包括CPU,内存，硬盘以及网卡等；
2. 备份服务器的操作系统；
3. 备份服务器的日常工作压力；
4. 客户端的硬件配置，包括CPU,内存，硬盘以及网卡/光口等；
5. 客户端的操作系统；
6. 客户端的日常工作压力；
7. 备份网络的硬件和配置情况；
8. 备份网络的拥塞情况；
9. 光纤存储网络的硬件和配置情况；
10. 光纤网络的拥塞情况；
11. 光纤传输距离以及交换机互联的带宽和跳数；
12. 不同的通信协议；
13. 通信协议的优化；
14. 最终的备份设备-磁带库的硬件和配置



怎么样，看了是不是有点晕？你一定没想到平时仅占工作一小部分的备份会这么复杂吧？我们先来看张图，看看从存储节点到VTL的数据流走向从而加深对上面各种性能因素的理解。



 

我们说的性能分析一定要结合上面所说的各种因素以及数据流走向通盘分析，从数据流的源端开始自上而下来看到底哪里是瓶颈的所在。其实，我一直喜欢把备份比喻成交通运输，把矿产运到指定的仓库。

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWYic4OUw50MP0iaaD65RraK7kiaiaL2Z680xuceg0swsQ4rKgPu7neu8FBdp5PL3Bg7juXXNSX3oEwwQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

运输前，首先是挖机在挖矿，然后卸到卡车的拖斗里面，卡车启动出发经过指定的路线到达目的地卸货然后返回到矿地继续运输。看似很简单吧？其实总的运输窗口完全取决于客户的需求，假如客户不急那么可以这样慢慢拉矿甚至可以用更小的车拉，这是出于对成本的考虑。那么假如客户要求加急，需要急用这些矿，怎么办？那就加急呗，当然这个加急费是免不了的，然后就会投入更多的性能极佳的工程车，运输车。多辆挖机同时采矿，然后装到更大的卡车，好几辆卡车同时跑运输运到指定的不同仓库，从而大大缩短了运输的窗口来满足客户的需求。所以，对于备份而言也是如此，只要能够满足你的备份时间窗口就可以了，没有最快只有更快，如果你想达到更好的备份性能，意味着你必须投入更多。回过头来看数据备份，读取源数据的速度，一次读的大小就好比有多少辆挖机同时在挖矿，再传输到备份服务器（卡车），一次传输的大小以及一次可以传多少数据流（卡车的大小以及数量），再经过多少传输距离，网络堵不堵等诸多因素决定了备份窗口时间。对应到相关的专用术语就是：TCPWINDOW SIZE,SEND/RECEIVE BUFFER SIZE,BUFFER SIZE,BLOCK SIZE,MULTIPLE STREAMS,MUTIPLEXING and ISL BANDWIDTH…

 

下面，就具体的每个节点再来和大家分享一下。



首先是备份服务器这一块。备份服务器是整个数据备份恢复的指挥所，它控制着所有的资源以及负责协调相关事件的运作。所以，它必须有强悍的硬件才能支撑起它每天繁忙的事务。本文不会就具体的服务器系统内核调优作阐述，详细可以参见不同备份软件厂商的性能调优指南。但是千万不要使得服务器过于繁忙，否则会影响整体的数据备份/恢复的性能，我们可以用具体的命令来查看服务器是否过于繁忙。比如-‘vmstat,sar,top…’等命令。另外网络的拥塞情况也要具体的查看，是不是需要用多个网卡做聚合？DNS服务器解析有没有延时等等。。。这些都会影响性能。



再来看一下媒体服务器。媒体服务器指的是直接可以和VTL通过光纤网络通信的服务器，因此它可以识别到VTL分配给它的磁带机设备。它在整个备份恢复环节中起着举足轻重的作用，因为它既接收来自网络客户端的备份数据流同时通过内存又将数据写到磁带设备。除了上面提到的足够强的硬件支撑以外，通常我们还需要在它的进口和出口下点功夫。进口就是服务器的网卡，是不是做了多网口聚合？有没有提高tcpwindowsize以及收发的buffer size?如果是千兆网卡的话，有没有提高MTU的大小？出口的话就是有几个光纤口通往VTL，有没有做负载均衡等等。。。光纤卡的frame size默认值是不是够大？比如，windows 32bit 2003/2008默认的frame size只有64K，需要调整注册表以及安装相应的驱动程序才能调整到1M以上。



现在该聊一聊备份客户端了。顾名思义，客户端指的就是真正需要做备份和恢复的服务器群体。除了上面所提到的服务器负载，网络出口的带宽等等，我们还要注意在备份的时候千万要把杀毒进程停掉，否则速度会非常慢。通常，现在的应用服务器都挂载着存储硬盘，所以RAID的配置以及LVM卷的管理也很重要。良好的卷管理，往往会整体提升IO数据读的响应时间。



最后，我们看一下关于备份软件以及数据库方面我们有哪些可以值得关注的？我们不提倡应用软件和数据库这边打开压缩和加密功能，因为这个直接会影响到data domain数据压缩比以及备份速度。其实我们DD本身也提供数据压缩和加密的服务，所以没有必要在应用端开启这些功能。谈及多数据流备份这块，就是一个客户端的备份数据集可以同时备份到多个磁带设备，那么设多少个流合理呢？通常的话根据物理硬盘的数量，一个物理硬盘可以对应一个数据流这样可以确保在读数据的时候磁头不会来回找多个文件而浪费时间。当今，RAID阵列环境中适当的增加数据流还是可以帮助提升性能的，但是并不是越多越好，有时候过多的数据流反而会降低性能以及占用过多的系统资源。对于那些小文件，我们建议采用snap image 的技术进行备份，再加上增加读的buffer size可以大大提升效率。除了上面所有提到的之外，相当重要的一点就是磁带设备的block size，很多备份厂商默认的值都较小只有64K左右，所以千万要增加块的大小，至少要256K以上，这一点尤为重要。

 

上面我们聊的都是一个个节点，下面我们从通信协议上看看有哪些地方需要关注的。



TCP/IP网络方面，我们可以增加tcpwindowsize 和buffer size来提升数据在网络传输过程中的吞吐量。



- Oracle Solaris

- - 设置TCPIPWINDOW SIZE 63k 或者更高

  - 编辑文件in_proto.c 来调整下面的buffer size

  - - tcp_default_mss-recommend is 1500 MTU

    - tcp_sendspace-changed to 16KB or 32KB

    - tcp_recvspace-changed to 16KB or 32KB

      

- AIX-no(network option)-我们可以使用’no’命令来调整网络参数

- - Use no –a to view current settings

  - When using TCP window sizes ≥ 64, set rfc1323 to 1

  - Here are the recommended values for the parameters described in this section

  - - § lowclust = 200
    - § lowmbuf = 400
    - § thewall = 131072
    - § mb_cl_hiwat = 1200
    - § sb_max = 1310720
    - § rfc1323 = 1          

- 

- Windows Platform

- - WIN2008: [HKEY_LOCAL_MACHINE\SYSTEM\ CurrentControlSet\Services\Tcpip\Parameters] Tcp1323Opts, REG_DWORD, 3
  - WINXP/2K3: [HKEY_LOCAL_MACHINE\SYSTEM\ CurrentControlSet\Services\Tcpip\Parameters] DefaultSendWindow"=dword:1048576

- 

- DefaultReceiveWindow"=dword:1048576

- GlobalMaxTcpWindowSize"=dword:1048576

- TcpWindowSize"=dword:1048576 

- Tcp1323Opts"=dword:3

- Linux-Check with “cat /proc/sys/net/ipv4/tcp_window_scaling” ,默认值应该大于64K





**SAN网络方面：**



1. 首先要排除有没有物理端口或者光纤线的问题。例如我们可以用交换机的命令查看“porterrshow”-可以查看是不是哪个SFP有错误，比如’crc error’等物理错误计数。如果你看到哪个口错误比较多的，还可以看看光强度是不是够，这个可以用命令’sfpshow’查看(brocade)，建议值是大于-7dbm。
2. 是否备份服务器和VTL跨多个交换机，建议不要超过3台交换机。另外，特别重要的是ISL带宽够不够用，备份数据流就像运矿的车，不单单体积大而且源源不断的在跑运输，所以马路宽不宽也很重要，否则就会造成堵车。
3. 长距离传输的话需要增加交换机的B2B credit buffer,这个就相当于tcp window size，一次可以传的数据大一点，可以免去在路上往返的开销。
4. 我们建议主机那边的光口只连接到VTL，不能共享，这个也可以避免出现意外的通讯故障。
5. Slow drain device-我们称之为累赘型设备。比如8G的SAN网络里连接了2G的节点，慢的设备会成为瓶颈所在，因为它处理数据很慢，其他设备都会因为等待它的回应而造成整体性能的下降。
6. Zoning的配置很重要，多个initiator放在一个zoning 有时候会造成性能问题，因为他们彼此会尝试握手建立连接，但是永远不成功，所以对性能会有些许的影响。

 

最后，再来谈谈DD本身到底什么情况下会影响性能呢？

1. DD本身有硬件问题，比如硬盘或者内存的问题。
2. 在出现坏的硬盘以后，RAID在数据重建，这个往往会消耗很多的系统资源。
3. 垃圾回收和复制在同时运行，因为他们会占用很多的资源，导致备份速度下降。我们建议备份窗口不要和它们重叠。
4. 系统空间是不是超过了85%，系统空间越满，DD会占用更多的时间来查找数据的唯一性。
5. VTL 的光口没有做到负载均衡。
6. VTL没有被充分利用，可以增加并发数据流来提高整体的吞吐量。
7. DD过于繁忙，没有过多的资源来进行快速的IO处理。我们可以用命令’iostat 2’来监控。

 

本次就聊得这里，对于DD 虚拟带库的性能问题概括起来就是先排除DD本身有没有问题，比如硬件问题，空间使用情况，系统资源负载情况，光纤口有没有做到负载均衡。



所有其他的瓶颈都是DD以外的，最直接的就是磁带设备的block size是不是大于256k。光纤网络有没有性能和配置问题以及备份主机的压力情况等等。总而言之，顺着单向的数据流一个个节点排查就是了。



















## 备份性能问题简单分析

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-06*

对于备份和恢复，除了关心数据是否真正能够被备份和恢复之外，我们也会比较关心它的速度，也就是所谓的性能，毕竟时间就是金钱嘛。况且不能数据都变化很多了，我们备份还一直在跑，这样也没有意义。

 

现在我就根据自己的经验来介绍一下可能会影响Avamar备份性能的因素，这样大家在以后的工作中遇到问题，可以简单的排查一下，从而有利于我们快速解决问题。

 

备份过程，简单来说就是客户端通过网络发送数据给Avamar服务器。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7MAG7iaOUmrUTcPGwJjGSZKY8Lrv9RgBTicPsgv4a87Z5J75H2VrneyhvUomrHibVcxXeIPsia0XAicg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

但是在这三部分，又有各种小的细节会影响备份速度。总体来说，影响备份性能的因素如下：

1. cache文件不够大。
2. 未被充分利用的CPU。
3. 客户端和Avamar服务器之间连接过慢（网络方面）。
4. 客户端磁盘性能不好（磁盘I/O）。
5. 内存过低（<3gb）。
6. Avamar服务器性能问题。

 

Avamar备份通常定义的标准速度是

- 文件系统备份 = 大约一百万文件每小时
- 数据库备份 = 大约100GB每小时



当然初次备份不算哦～～

 

下面我们来具体看一下：



- **cache文件不够大**



首先请了解我们客户端主要有两种cache文件。f_cache主要用于文件系统备份，p_cache主要用于数据库类型备份。f_cache默认的总大小是物理RAM的1/8，p_cache是物理RAM的1/16。另外，cache文件的大小是成倍增长的，而不是一点一点增加。比如当前的cache文件大小是300MB的话，下一次增长它的大小就是600MB。

 

同时，我们都知道，Avamar是前端去重备份机制，它主要是基于cache文件来去重的。在之前“浅谈Avamar备份如何处理文件”这篇文章里面我们讲到备份开始的时候Avamar会对比本地文件和cache文件来决定哪些数据需要通过网络发送给Avamar服务器，哪些是已经备份过的数据，而不需要再次发送。

 

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7MAG7iaOUmrUTcPGwJjGSZrB7sozxzQpSoWUreh0yC8gPdhucFaeKwY0e7ZKRtoK29BNgrn4rySQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

基于以上信息，如果默认的或者您限定的cache文件总的大小过小，从而导致它无法继续增长，备份速度就会受到很大影响。这时候我们就需要检查当前cache文件大小和它总的大小，决定是否更改其原来的值，从而改善备份速度。从备份日志里面，我们可以根据以下信息判断cache文件大小是否足够：



F_cache:

2014-02-04 06:34:37 avtar Warning <6562>: CAPACITY WARNING: The file cache is full; filecachemax=256MB, 2097150 entries overflowed.



P_cache;

<HASH_CACHE>entries=2097152,added=709614, overflow=56849</HASH_CACHE>

 

改变方法：登录到客户端，在c:\Program files\avs\var目录下，编辑或者创建avtar.cmd文件，添加以下参数：

--filecachemax=<size in MB> or <size in fraction>

--hashcachemax=<size in MB> or <size in fraction>

注意：cache文件大小不要超过物理RAM的1/4，因为这样也会影响性能。

 

- **未被充分利用的CPU**



例子：2013-02-07 08:12:59 avtar Info <8688>: Status 2013-02-07 08:12:59, 7,758,607 files, 156,089 folders, 380.4 GB (3,821,086 files, 128.5 GB, 33.80% new) 623MB 4% CPU X:\images\IMAGES29\3704\

 

从上面备份结果我们看出备份过程CPU利用率只有4%。这种情况一般说明客户端比较忙（运行其他程序）或者磁盘性能有问题。

 

另外，一些第三方杀毒软件也会影响备份速度。

一般杀毒软件工作机制是如果有个程序打开某个文件，它就会去扫描一下这个文件以确保没有病毒。这种情况下，如果每个被备份的文件都被扫描，备份速度看起来就会很慢。所以，如果您需要备份某个客户端，请确保将avtar.exe加入到杀毒软件的安全列表中。

 

- **客户端和Avamar服务器之间连接过慢（网络方面）**



这种情况下，我们看到日志通常会有以下内容：

2013-03-08 02:33:20 avtar Info <8688>: Status 2013-03-08 02:33:20, 2,713 files, 695 folders, 1.198 GB (56 files, 809.2 KB, 0.06% new) 33MB  0% CPU C:\Documents and Settings\cnwhite\ntuser.dat.LOG

2013-03-08 02:35:23 avtar Info <7694>: Server(mkeavbak05.mke.ra.rockwell.com) not responding (possible network congestion?) (600 seconds)

2013-03-08 02:39:39 avtar Info <7695>: Server(mkeavbak05.mke.ra.rockwell.com) is back (855 seconds)

2013-03-08 02:44:39 avtar Info <7694>: Server(mkeavbak05.mke.ra.rockwell.com) not responding (possible network congestion?) (300 seconds)

 

其实如果真的是网络问题所引起的性能缓慢，就已经不是我们Avamar技术支持人员要参与的操作了，但是为了帮助客户了解形势，我们一般也会帮助客户做一些基本测试（当然最好是能够有专门的网络工程师帮忙测试了^_^这需要客户的配合）。我们通常会使用iperf测试客户端和服务器之间的网络带宽。具体步骤如下：

- 登录到客户端，打开putty并连接到Avamar  Server。
- 然后在putty上面运行命令：iperf -s -i 1
- 在命令运行的同时，也在客户端上面运行以下iperf命令：
- iperf -c AvamarServerIP -i 1
- 命令运行一段时间后中断操作然后查看结果。



我们也会运行备份测试，使用randchunk 参数来生成日志从而检测备份时使用的带宽：

avtar -c --randchunk=10000 --compress=none --status=60 --comstats –nocache --logfile=c:\randchunk.log --id=MCUser

--ap=MCUser1 --server=Avamar.emc.com --path=/clients/DaveTemplin.emc.com

 

如果是要测试网络延迟和丢包的话，可以使用常ping和tcpdump来检测。

 

- **客户端磁盘性能不好（磁盘I/O）**



其实，一般performance问题做下来，都是客户端磁盘性能不够好，但是一般客户最开始时候都不愿接受这种结果。所以我们通常会经过一系列的备份测试帮助客户去检查并了解情况，最终找到根本原因。

 

对于磁盘性能的测试，说实话，我们更希望客户自己能检查，毕竟我们在这方面的经验没有系统维护工程师或者存储管理员有经验丰富（囧）。但是我们还是会尽力滴，作为参考我们会采取以下措施去判断问题：

1. 利用windows自带的performance测试工具performance monitor去观察磁盘性能。
2. 手动从客户端复制文件到另外一个客户端看其花费的时间是否正常。
3. 运行一个备份测试，加上—degenerate参数，例如：



avtar -c --degenerate --compress=none --nocache --logfile=c:\degenerate.log

--id=MCUser --ap=MCUser1 --server=Avamar.emc.com --path=/clients/DaveTemplin.emc.com E:\testdata

有了这个参数，数据是不会真正通过网络被发送到Avamar服务器去的，这样我们可以通过备份速度来判断客户端这边是否有性能问题。

 

- **内存过低（<3gb）**



这个就是客户端系统资源的问题了。如果系统资源过少，Avamar运行时能用的memory就会很少从而影响备份速度。

 

- **Avamar服务器性能问题**



这里也会涉及到很多，比如Avamar服务器很忙，某个节点的性能不好，gsan或者msc问题等等。

如果是这种情况的话，您所有的备份都可能会受到影响，或者至少大部分备份都会有问题，这时候，就放心交给我们来检查吧。

 

当然，我们也会单纯的从Avamar角度进行日志分析，然后大概判断问题所在。经典的做法就是：

1. 登录到客户端，打开C:\Program Files\avs\var文件夹。

2. 创建并编辑avtar.cmd文件，加入以下参数：

   --stats

   --status=60

   --comstats

3. 保存此文件然后再次发起一个备份。等备份再次失败之后，收集日志并分析。

 

那么这些参数有什么用呢？

- comstats 参数用于诊断avtar和gsan之间通信问题（每秒）
- Avtar comstats 说明:

avtar Stats <0000>: 2013-10-11 06:18:20 COMSTATS:0 sent= 84 recv[0]= 84 pending= 1/ 5 int= 0/50 send= 0 bytes= 9408+ 17711 sleepms= 0 delay=(0.008 [0.000..0.210] sd=0.030 n= 53) (0.022 [0.000..0.324] sd=0.066 n= 31)

此条信息显示客户端数据发送量和服务器接受量，等待的数据量和数据延迟时间。通常我们会根据此信息判断是客户端数据发送不过来还是服务器太忙从而无法接受客户端发的数据，已经接收数据是否有延迟。

- 2013-11-14 10:16:56 avtar Info <8688>: Status 2011-11-14 10:16:56, 328 files, 16 folders, 26.53 MB (328 files, 15.35 MB, 57.86% new) 34MB  1% CPU \\cifs-fileserver\myHomeDir\SomeFolder\TextDocument.doc

--status=60参数会每个60秒输出出来当前在备份哪个文件，目前为止扫描了多少文件，大小是多少，新增的数据量等等。

 

上面说了这么多，也不是说一有备份性能问题就由大家自己去检查，我们完全置身事外。只是希望在大家的配合下，我们能更快速有效的解决问题。

 

更具体的东西我就不介绍了，因为太深入或者太多的日志分析也会让大家觉得很烦。希望这些信息能给大家一个初步印象，那就是备份性能不是某一方面的因素决定的。

 

如果大家的工作中遇到任何问题，欢迎随时联系我们，一如既往，我们是很乐意和大家共同来处理分析并解决问题的。















## 虚拟机备份恢复简介和常见案例分析

原创 EMC中文技术社区 [戴尔易安信技术支持](javascript:void(0);) *2016-06-06*

说起VMWare的备份和恢复，大家可能平时都会涉及到很多，现在我就给大家简单介绍一下并根据自己的经验分享一些案例，希望能给你们一些参考。

 

我们都知道VMWare有两种备份方式VMWare image backup和Guest backup。它们都各有一些什么特点呢？如何处理一些常见问题呢？那么请继续往下看：

 

**Image backup：**

image备份更适用于那些非应用程序的服务器环境。比如单纯的文件服务器环境等。



**特点：**

1. 利用vCenter的优势去检测到虚机然后把它们批量加入Avamar server.
2. 需要进行一些初始化的设置和配置。



**配置方式：**

VMWare备份是通过VMware vStorage API for Data Protection (VADP) 进行的。基本需要配置以下环境：

1. 把vCenter加入Avamar server.
2. 配置proxy并把它注册到Avamar domain。
3. 在Avamar GUI上面配置，确保proxy会保护VMs所在的datastore。
4. 将VM加入到vCenter域。



配置完之后，确保在Proxy, Avamar server和vCenter之间的443端口是开通的，proxy和ESX之间的902端口是开通的并且它们之间没有网络连接的情况下，我们就可以进行备份啦。以下是image 备份和恢复的图表，请参考：

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7MAG7iaOUmrUTcPGwJjGSZ1Niaicl79SBZqcy3XDQHtIBYd06wsj1wZIiatYstWlGX4RILGqkxT10HQ/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

**常见image备份问题：**

1. No proxy：这种问题通常发生在proxy不可用或者虚拟机所在的datastore没有被任何proxy保护。您可以检查以下信息：

2. - 确保proxy是开机的状态，通过Avamar GUI->Policy->Client-Edit Proxy client检查备份是enabled的。

   - Avamar GUI->Backup and Restore，确保可以展开proxy的“Linux file system” plugin。

   - Avamar GUI –> Policy –> Client –> Edit the proxy client –> VMware 选项，确保虚拟机所在的datastore被选中了。

   - 如果所有的虚拟机备份都有问题，可以尝试到Avamar GUI –> Administration> – Service Administration> – Restart the connection to vCenter重启一下vCenter connection，然后测试备份。

     

3. No VM：请检查并确保虚拟机是存在的而且Avamar server和vCenter之间连接没有问题。

4. - VM是否存在在vCenter？
   - 存在的话，那它是否被重命名过？
   - 没有重命名的话，那它是否进行过迁移？
   - 如果VM存在，那么是否所有VM都有问题？或者说只是某些特定的虚拟机有问题？
   - 重新发起备份能重现问题吗？
   - 尝试添加一台新的虚拟机到vCenter，有问题吗？
   - vCenter账号密码是否被更改过但是Avamar GUI上面并没有相应的更新？等等。

5. 如果一台虚拟机有多个磁盘，而且磁盘放在不同的datastore上，备份时您可能会遇到以下报错：

   "Too many extra snapshot files (%d) were found on the VMs datastore.

   This can cause a problem for the backup or restore."

   在这种情况下，您可以使用skip_datastore_check参数去跳过snapshot的检查从而使备份成功完成。

6. 备份速度太慢。这种情况，我们需要确保CBT是启用的，同时看一下备份是否使用的是hotadd传输方式，不是的话，需要检查原因。根据我们的经验，如果虚拟机所在的datastore和proxy所在的datastore不同，备份时候可能不会使用hotadd从而导致备份速度过慢的问题。我们需要在虚拟机所在的datastore配置一台proxy来解决问题。

7. vCenter账户权限没有问题，但是备份失败，报错如下：

===

2013-07-29 22:54:41 avvcbimage Error <12015>: Failed to connect to virtual disk [VNX-xxx-DS11] ATL_xxx-New/ATL_xxx-New-000001.vmdk (13) (13) You do not have access rights to this file

2013-07-29 22:54:41 avvcbimage Error <9767>: VixDiskLib_Open([VNX-xxx-DS11] ATL_xxx-New/ATL_xxx-New-000001.vmdk) returned (13) You do not have access rights to this file

2013-07-29 22:54:41 avvcbimage Warning <16053>: This access rights error may have been caused by a VM flag in the wrong state for Windows Server 2008

2013-07-29 22:54:41 avvcbimage Warning <16054>: Please check the 'Configuration Parameters' settings of the VM and make sure the 'disk.EnableUUID' is set to 'false'.

===

这种问题一般在备份Win2008系统的时候才会出现，解决方案：

- 备份时候加入参数[avvcbimage]quiesce_fs=false
- 或者编辑虚拟机设置edit setting-> option-> config parameter，将disk.EnableUUID设为false。

NOTE: Avamar v6版本中这种问题比较常见。

 



**Image restore：**



image恢复有两种方式，

1. 将整机恢复或者将其中的某个或者某几个磁盘恢复。特点：高效，快速。流程如下：

   ![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7MAG7iaOUmrUTcPGwJjGSZ9S1Ymx6GhuMV5Cy13fXYibwo8SaCHiacEeLEdz3APt7Pza4ib0faBMzaw/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

   

2. File level restore，通过这种方式您可以只恢复image中的某些特定的文件，灵活，便捷。特点：

3. 1. 只适用于恢复一些小的文件，同一个恢复操作中文件夹或者文件数量不能超过5000.
   2. 大文件的恢复的话速度会很慢，有时候甚至比恢复整机的速度都慢。
   3. 而且一下磁盘的image备份是不支持FLR的：

- - - Unformatted disks
    - Dynamic disks
    - GUID Partition Table (GPT) disks
    - Ext4 file systems
    - FAT16 file systems
    - FAT32 file systems
    - Extended partitions (Types: 05h, 0Fh, 85h, C5h, D5h)
    - Two or more virtual disks mapped to single partition
    - Encrypted partitions
    - Compressed partitions

![图片](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIW7MAG7iaOUmrUTcPGwJjGSZIY7nMLRsanicSfuQGpCnzm8DuTpUs5OxyKIuJic8Fewianxu5j1Eicjeyg/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

**Image备份的恢复常见问题：**

其实整机恢复的话，只要按照我们的操作流程，基本没什么问题。但是由于FLR恢复比较特殊，会有一些常见问题：

1. 比如说虚拟机有两块磁盘，整机恢复的时候可以看到有两块磁盘，但是试图去做FLR的时候，只能看到一块磁盘或者一块都看不到。通常这是因为那个（些）磁盘类型是不支持FLR的，我们需要去登录到虚拟机上面查看它的磁盘类型，对比我们的不支持的磁盘类型列表，查看他们是否属于那些类型。

2. FLR恢复速度特别慢。这是因为用户尝试去恢复比较大的文件或者文件数过多。通常我们会建议进行整机恢复然后获取所需的文件。

3. FLR恢复时报错："The VMDK filename is not valid or present. Verify that the proxy was correctly registered using the supported method in the documentation".

4. - 检查proxy状态，确保它是正常工作的。
   - 这个能是因为axionfs服务hung了或者无法正常工作，可以尝试在没有备份运行的情况下，在proxy上面重启此服务：service axionfs restart





**Guest backup：**



比较适用于那些安装有一些应用程序的环境，比如Microsoft Exchange, Microsoft Office SharePoint, Microsoft SQL Server, and Oracle。因为这些环境在恢复的时候对数据有特殊的要求，在备份时候我们就需要使用相应的plugin从而保证恢复出来的数据是可用的。



**特点：**

1. 需要根据应用程序的不同，安装不同的plugin。
2. 能够备份应用程序，比如DB2, Exchange, Oracle, and SQL Server databases。
3. 比较容易满足现在的备份框架。
4. 相对于image备份的批量处理方式，guest备份需要在每台虚拟机上面安装Avamar plugin，分别配置。



**配置方式：**

简单来说，虚拟机的guest备份配置和配置一台普通的客户端是没有区别的。

1. 在客户端上面安装Avamar client，将其注册到Avamar域。
2. 客户端上面装有什么类型的应用程序，您就需要安装对应的plugin类型。



总的来说，对于一台虚拟机，您可以对其只进行image备份，也可以只进行guest备份。但是如果两种备份方式都需要的话，需要将Avamar server上面的/usr/local/avamar/var/mc/server_data/prefs/mcserver.xml文件中allow_duplicate_client_names的值设为true。

注意：更改完之后需要重启MCS服务。

 

**Guest restore**：既然它的备份和普通客户端的备份是没有区别的，恢复的时候也是一样的道理。不用应用程序的恢复需要参考相对应的用户手册。

 

以上是根据我们的经验对虚拟机备份和恢复的简单总结，当然在实际的操作中，还是会遇到各种各样的问题，比如怎么配置proxy，proxy注册不了，虚拟机备份失败等等等等，而且解决以上的案例也没有绝对解决方案，针对实际问题，我们还是需要进行分析并发现根本原因。

 

如果大家对于这些信息有任何的疑问或者见解，欢迎随时提出来，我们将很乐意和大家在这里探讨。同时如果有一些好的经验，也可以在这里和其他用户共享。谢谢！

















